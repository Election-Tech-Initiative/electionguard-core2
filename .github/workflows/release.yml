name: Release

on:
  milestone:
    types: [closed]
  push:
    tags:
      - "v*.*.*"

env:
  TARGET: Release

jobs:
  get_version_code:
    name: Get Version Code
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.get_version_code.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Get Version Code
        id: get_version_code
        run: |
          TAG_NAME=${GITHUB_REF/refs\/tags\//} # v1.0.0
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          BUILD_NUMBER=$(echo $TAG_NAME | grep -oP '\d+$')
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          VERSION="${TAG_NAME/v}-$BUILD_NUMBER"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  linux_build_x64:
    name: Linux Build (x64)
    runs-on: ubuntu-22.04
    env:
      compiler: clang
      compiler_version: 14
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Update Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-${{ env.compiler_version }} g++-multilib
          echo "CC=clang-${{ env.compiler_version }}" >> $GITHUB_ENV
          echo "CXX=clang++-${{ env.compiler_version }}" >> $GITHUB_ENV
      - name: Configure Environment
        run: make environment
      - name: Build
        run: make build-x64
      - name: Upload Library (x64)
        uses: actions/upload-artifact@v3
        with:
          name: linux-x64
          path: |
            build/libs/Linux/x64/Release/src/*.so
            build/libs/Linux/x64/Release/libs/hacl/*.so

  maccatalyst_build_arm64:
    name: MacCatalyst Build (arm64)
    runs-on: macos-13
    env:
      compiler_version: 14.2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Setup Compiler
        run: sudo xcode-select -switch /Applications/Xcode_${{ env.compiler_version }}.app
      - name: Configure Environment
        run: make environment
      - name: Build
        run: make build-maccatalyst
      - name: Upload Library (x64)
        uses: actions/upload-artifact@v3
        with:
          name: osx-arm64
          path: |
            build/libs/MacCatalyst/arm64/Release/src/*.dylib
            build/libs/MacCatalyst/arm64/Release/libs/hacl/*.a
            build/libs/MacCatalyst/arm64/Release/libs/hacl/*.dylib

  macos_build_arm64:
    name: MacOS Build (arm64)
    runs-on: macos-13
    env:
      compiler_version: 14.2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Setup Compiler
        run: sudo xcode-select -switch /Applications/Xcode_${{ env.compiler_version }}.app
      - name: Configure Environment
        run: make environment
      - name: Build
        run: make build-arm64
      - name: Upload Library (x64)
        uses: actions/upload-artifact@v3
        with:
          name: maccatalyst-arm64
          path: |
            build/libs/Darwin/arm64/Release/src/*.dylib
            build/libs/Darwin/arm64/Release/libs/hacl/*.a
            build/libs/Darwin/arm64/Release/libs/hacl/*.dylib

  macos_build_x64:
    name: MacOS Build (x64)
    runs-on: macos-13
    env:
      compiler_version: 14.2
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Setup Compiler
        run: sudo xcode-select -switch /Applications/Xcode_${{ env.compiler_version }}.app
      - name: Configure Environment
        run: make environment
      - name: Build
        run: make build-x64
      - name: Upload Library (x64)
        uses: actions/upload-artifact@v3
        with:
          name: osx-x64
          path: |
            build/libs/Darwin/x64/Release/src/*.dylib
            build/libs/Darwin/x64/Release/libs/hacl/*.a
            build/libs/Darwin/x64/Release/libs/hacl/*.dylib

  wasm_build:
    name: WASM Build
    runs-on: ubuntu-22.04
    env:
      compiler: clang
      compiler_version: 14
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Update Environment
        run: |
          sudo apt-get update
          make environment-wasm
          source ./.cache/emscripten/emsdk_env.sh
      - name: Configure Environment
        run: make environment
      - name: Build
        run: make build-wasm
      - name: Upload Library (wasm)
        uses: actions/upload-artifact@v3
        with:
          name: wasm
          path: |
            build/libs/wasm/Release/src/electionguard/wasm/*.js
            build/libs/wasm/Release/src/electionguard/wasm/*.wasm

  # TODO: win x86

  windows_build_x64:
    name: Windows Build (x64)
    runs-on: windows-2022
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.x
      - name: Setup Environment
        run: make environment
      - name: Build
        run: make build-x64
      - name: Upload Library (x64)
        uses: actions/upload-artifact@v3
        with:
          name: win-x64
          path: |
            build/libs/Windows/x64/Release/src/Release/*.dll*
            build/libs/Windows/x64/Release/libs/hacl/Release/*.dll*

  publish_nuget:
    name: Publish Nuget
    needs:
      [
        get_version_code,
        linux_build_x64,
        maccatalyst_build_arm64,
        macos_build_arm64,
        macos_build_x64,
        windows_build_x64,
      ]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Setup Environment
        run: make environment
      
      - name: Get Linux x64 Artifacts
        uses: actions/download-artifact@v3
        with:
          name: linux-x64
          path: build/libs/Linux/x64/Release

      - name: Get MacCatalyst arm64 Artifacts
        uses: actions/download-artifact@v3
        with:
          name: maccatalyst-arm64
          path: build/libs/MacCatalyst/arm64/Release

      - name: Get MacOS arm64 Artifacts
        uses: actions/download-artifact@v3
        with:
          name: osx-arm64
          path: build/libs/Darwin/arm64/Release

      - name: Get MacOS x64 Artifacts
        uses: actions/download-artifact@v3
        with:
          name: osx-x64
          path: build/libs/Darwin/x64/Release

      - name: Get Windows x64 Artifacts
        uses: actions/download-artifact@v3
        with:
          name: win-x64
          path: build/libs/Windows/x64/src/Release

      - name: Update version number
        run: |
          echo $VERSION
          dotnet tool install --global dotnet-version-cli
          dotnet version ./bindings/netstandard/ElectionGuard/ElectionGuard.Encryption/ElectionGuard.Encryption.csproj ${{needs.get_version_code.outputs.version}}

      - name: Build and Package
        working-directory: bindings/netstandard/ElectionGuard/ElectionGuard.Encryption
        run: |
          dotnet build -c Release
          dotnet pack -c Release

      - name: Upload Nuget
        uses: actions/upload-artifact@v3
        with:
          name: nuget
          path: bindings/netstandard/ElectionGuard/ElectionGuard.Encryption/bin/Release/*.nupkg

      # - name: Publish to Nuget.org
      #   working-directory: bindings/netstandard/ElectionGuard/ElectionGuard.Encryption
      #   run: dotnet nuget push "**/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json --skip-duplicate

  publish_npm:
    name: Publish NPM
    needs: [get_version_code, wasm_build]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: 16
      - name: Get WASM Artifacts
        uses: actions/download-artifact@v3
        with:
          name: wasm
          path: bindings/typescript/src/wasm
      # - name: Copy WASM Artifacts
      #   run: |
      #     cp build/libs/wasm/Release/src/wasm/*.js bindings/typescript/src/wasm
      #     cp build/libs/wasm/Release/src/wasm/*.wasm bindings/typescript/src/wasm
      - name: Install Dependencies
        working-directory: bindings/typescript
        run: npm install
      - name: Update version number
        working-directory: bindings/typescript
        run: npm version ${{needs.get_version_code.outputs.version}} --no-git-tag-version
      - name: Publish to NPM
        working-directory: bindings/typescript
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_REGISTRY_TOKEN }}" > .npmrc
          echo $VERSION
          npm run package
          npm publish

  # publish_release:
  #   name: Publish Release
  #   needs: [publish_nuget, publish_npm]
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - name: Get Release Version
  #       id: get_version
  #       uses: greenygh0st/net-proj-release-version@v2
  #       with:
  #         PROJ_FILE: ./bindings/netstandard/ElectionGuard/ElectionGuard.Encryption/ElectionGuard.Encryption.csproj

  #     - name: Create Github Release
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         name: Release ${{ steps.get_version.outputs.RELEASE_VERSION }}
  #         tag_name: v${{ steps.get_version.outputs.RELEASE_VERSION }}
  #         draft: true
  #         prerelease: false
          # files: |
          #   ./bindings/netstandard/ElectionGuard/ElectionGuard.Encryption/bin/Release/*.nupkg
          #   ./build/libs/Darwin/arm64/Release/src/*.dylib
          #   ./build/libs/Darwin/x64/Release/src/*.dylib
          #   ./build/libs/Darwin/arm64/Release/src/*.dylib
          #   ./build/libs/Linux/x64/Release/src/*.so
          #   ./build/libs/Windows/x64/Release/src/Release/*.dll*
          #   ./build/libs/Windows/x64/Release/libs/hacl/Release/*.dll*
          # TODO: windows x86, changelog?
